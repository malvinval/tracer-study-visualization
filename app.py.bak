import streamlit as st
import pandas as pd
import plotly.express as px
import json

# Load the Excel file
file_path = "tracer_final.xlsx"  # Ensure this file is in the same directory
data = pd.read_excel(file_path)

# Handle NaN values in specific columns
data['PendapatanPerbulan'] = data['PendapatanPerbulan'].fillna(0)

# Streamlit app setup
st.set_page_config(layout="wide")  # Wide layout
st.title("Dashboard Tracer Study Alumni")

# Function to apply filters
def apply_filters(data, tahun_lulus, prodi):
    if tahun_lulus != "Semua":
        data = data[data["TahunLulus"] == tahun_lulus]
    if prodi != "Semua":
        data = data[data["Prodi"] == prodi]
    return data

# Sidebar for filtering
st.sidebar.title("Filter Dashboard")
tahun_lulus_filter = st.sidebar.selectbox(
    "Pilih Tahun Lulus", 
    options=["Semua"] + sorted(data["TahunLulus"].unique().tolist())
)
prodi_filter = st.sidebar.selectbox(
    "Pilih Prodi", 
    options=["Semua"] + sorted(data["Prodi"].unique().tolist())
)

# Apply filters
filtered_data = apply_filters(data, tahun_lulus_filter, prodi_filter)

# Dashboard metrics (at the top)
col1, col2 = st.columns(2)

with col1:
    st.subheader("Jumlah Pengisi Form")
    jumlah_pengisi = filtered_data.shape[0]
    st.metric(label="", value=jumlah_pengisi)

with col2:
    st.subheader("Pendapatan Tertinggi")
    pendapatan_tertinggi = filtered_data['PendapatanPerbulan'].max()
    st.metric(label="", value=f"Rp {pendapatan_tertinggi:,.0f}")

# Add some space
st.markdown("<hr>", unsafe_allow_html=True)

# Row 1: Donut Chart and Bar Chart
col1, col2 = st.columns([2, 2])

with col1:
    st.write("<h4>Distribusi Alumni Berdasarkan Status Pekerjaan</h4>", unsafe_allow_html=True)
    # Donut Chart - Alumni Status Pekerjaan
    filtered_data_status_pekerjaan = filtered_data.dropna(subset=['StatusPekerjaan'])
    status_chart = px.pie(
        filtered_data_status_pekerjaan['StatusPekerjaan'].value_counts().reset_index(),
        names='StatusPekerjaan',
        values='count',
        hole=0.4,
    )
    st.plotly_chart(status_chart, use_container_width=True)

with col2:
    st.write("<h4>Distribusi Alumni Berdasarkan Jenis Perusahaan</h4>", unsafe_allow_html=True)
    # Bar Chart - Alumni Jenis Perusahaan
    filtered_data_jenis_perusahaan = filtered_data.dropna(subset=['JenisPerusahaan'])
    jenis_chart = px.bar(
        filtered_data_jenis_perusahaan['JenisPerusahaan'].value_counts().reset_index(),
        x='count',
        y='JenisPerusahaan',
        labels={'index': 'Jenis Perusahaan', 'JenisPerusahaan': ''},
    )
    st.plotly_chart(jenis_chart, use_container_width=True)

# Add some space
st.markdown("<hr>", unsafe_allow_html=True)

# Row 2: Choropleth Map
col1, col2, col3 = st.columns([3, 2, 1])

with col1:
    st.write("<h4>Distribusi Alumni di Indonesia</h4>", unsafe_allow_html=True)
    # Map - Distribusi Alumni Berdasarkan Tempat Kerja (Provinsi)
    map_data = filtered_data.dropna(subset=['latitude', 'longitude'])
    st.map(map_data[['latitude', 'longitude']], use_container_width=True)
    
with col2:
    st.write("<h4>Distribusi Alumni di Luar Negeri</h4>", unsafe_allow_html=True)
    # Tabel - 5 Wilayah Terbanyak di Luar Indonesia
    filtered_data = filtered_data.dropna(subset=['DaerahTempatKerja'])
    luar_indonesia = filtered_data[~filtered_data['DaerahTempatKerja'].str.contains('JAWA BARAT|DKI JAKARTA|BANTEN|JAWA TENGAH|JAWA TIMUR|DI YOGYAKARTA|SUMATERA SELATAN|SULAWESI UTARA|MALUKU|RIAU|LAMPUNG|SUMATERA BARAT|KALIMANTAN TENGAH|SULAWESI TENGAH|SULAWESI TENGGARA|KEPULAUAN BANGKA BELITUNG|KALIMANTAN TIMUR|NUSA TENGGARA TIMUR|KALIMANTAN UTARA|SUMATERA UTARA|BALI|SULAWESI SELATAN')]
    wilayah_terbanyak = luar_indonesia['DaerahTempatKerja'].value_counts().head(5).reset_index()
    wilayah_terbanyak.columns = ['Wilayah', 'Jumlah']
    st.table(wilayah_terbanyak)

# Add some space
st.markdown("<hr>", unsafe_allow_html=True)

# Row 3: Bar Chart - Rentang Pendapatan
pendapatan_chart_col = st.columns([2])

with pendapatan_chart_col[0]:
    # Bar Chart - Rentang Pendapatan
    bins = [0, 6_000_000, 10_000_000, 30_000_000, float('inf')]
    labels = ['< 6 Juta', '6-10 Juta', '10-30 Juta', '> 30 Juta']
    filtered_data['RentangPendapatan'] = pd.cut(filtered_data['PendapatanPerbulan'], bins=bins, labels=labels, right=True)

    st.write("<h4>Distribusi Alumni Berdasarkan Rentang Pendapatan</h4>", unsafe_allow_html=True)

    pendapatan_chart = px.bar(
        filtered_data['RentangPendapatan'].value_counts().reset_index(),
        x='count',
        y='RentangPendapatan',
        labels={'index': 'Rentang Pendapatan', 'RentangPendapatan': 'Jumlah'},
    )

    st.plotly_chart(pendapatan_chart, use_container_width=True)
